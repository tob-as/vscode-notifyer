<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Approval Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: #252525;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #333;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: #888;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #666;
    }

    .status-dot.connected {
      background: #00cc00;
      box-shadow: 0 0 8px #00cc0066;
    }

    .status-dot.disconnected {
      background: #cc0000;
    }

    .summary {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .summary-card {
      background: #252525;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px 24px;
      min-width: 140px;
    }

    .summary-card .label {
      font-size: 0.8rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .summary-card .value {
      font-size: 2rem;
      font-weight: 700;
    }

    .summary-card.pending .value {
      color: #cc0000;
    }

    .summary-card.running .value {
      color: #00cc00;
    }

    .summary-card.idle .value {
      color: #cccc00;
    }

    .projects {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .project-card {
      background: #252525;
      border: 2px solid #333;
      border-radius: 12px;
      overflow: hidden;
      transition: border-color 0.2s;
    }

    .project-card.waiting_approval {
      border-color: #cc0000;
    }

    .project-card.running {
      border-color: #006600;
    }

    .project-card.idle {
      border-color: #666600;
    }

    .project-card.offline {
      border-color: #333;
      opacity: 0.6;
    }

    .project-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: #2a2a2a;
    }

    .project-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .project-indicator {
      width: 14px;
      height: 14px;
      border-radius: 50%;
    }

    .project-indicator.waiting_approval {
      background: #cc0000;
      box-shadow: 0 0 10px #cc000066;
      animation: pulse 1.5s infinite;
    }

    .project-indicator.running {
      background: #006600;
    }

    .project-indicator.idle {
      background: #666600;
    }

    .project-indicator.offline {
      background: #333;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .project-name {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .project-status {
      font-size: 0.85rem;
      color: #888;
    }

    .pending-badge {
      background: #cc0000;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .project-body {
      padding: 16px 20px;
    }

    .no-approvals {
      color: #666;
      font-style: italic;
    }

    .approval-item {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .approval-item:last-child {
      margin-bottom: 0;
    }

    .approval-message {
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      color: #e0e0e0;
      background: #222;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .approval-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: #888;
      margin-bottom: 12px;
    }

    .severity-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      text-transform: uppercase;
      font-weight: 600;
    }

    .severity-badge.info {
      background: #003366;
      color: #66ccff;
    }

    .severity-badge.warning {
      background: #665500;
      color: #ffcc00;
    }

    .severity-badge.error {
      background: #660000;
      color: #ff6666;
    }

    .approval-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .approval-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .approval-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .approval-btn.yes {
      background: #006600;
      color: white;
    }

    .approval-btn.yes:hover:not(:disabled) {
      background: #008800;
    }

    .approval-btn.no {
      background: #660000;
      color: white;
    }

    .approval-btn.no:hover:not(:disabled) {
      background: #880000;
    }

    .approval-btn.remember {
      background: #004466;
      color: white;
    }

    .approval-btn.remember:hover:not(:disabled) {
      background: #006688;
    }

    .approval-btn.loading {
      position: relative;
    }

    .approval-btn.loading::after {
      content: '';
      width: 14px;
      height: 14px;
      border: 2px solid transparent;
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state h2 {
      font-size: 1.5rem;
      margin-bottom: 10px;
    }

    .error-banner {
      background: #660000;
      color: #ff6666;
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .error-banner.visible {
      display: block;
    }

    .time-ago {
      color: #888;
    }

    .project-meta {
      font-size: 0.8rem;
      color: #666;
      padding: 0 20px 12px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>
      <span>Approval Dashboard</span>
    </h1>
    <div class="connection-status">
      <span class="status-dot" id="connectionDot"></span>
      <span id="connectionText">Connecting...</span>
    </div>
  </div>

  <div class="error-banner" id="errorBanner"></div>

  <div class="summary" id="summary">
    <div class="summary-card pending">
      <div class="label">Pending</div>
      <div class="value" id="totalPending">0</div>
    </div>
    <div class="summary-card running">
      <div class="label">Running</div>
      <div class="value" id="runningCount">0</div>
    </div>
    <div class="summary-card idle">
      <div class="label">Idle</div>
      <div class="value" id="idleCount">0</div>
    </div>
  </div>

  <div class="projects" id="projects">
    <div class="empty-state">
      <h2>No Projects</h2>
      <p>Waiting for VS Code extensions to connect...</p>
    </div>
  </div>

  <script>
    // State
    let projects = [];
    let summary = { totalPending: 0, runningCount: 0, idleCount: 0 };
    let eventSource = null;
    let reconnectTimer = null;
    let loadingRequests = new Set();

    // DOM elements
    const connectionDot = document.getElementById('connectionDot');
    const connectionText = document.getElementById('connectionText');
    const errorBanner = document.getElementById('errorBanner');
    const projectsContainer = document.getElementById('projects');
    const totalPendingEl = document.getElementById('totalPending');
    const runningCountEl = document.getElementById('runningCount');
    const idleCountEl = document.getElementById('idleCount');

    // Format time ago
    function formatTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    // Format duration
    function formatDuration(ms) {
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${minutes}:${secs.toString().padStart(2, '0')}`;
    }

    // Update summary display
    function updateSummary() {
      totalPendingEl.textContent = summary.totalPending;
      runningCountEl.textContent = summary.runningCount;
      idleCountEl.textContent = summary.idleCount;

      // Update page title
      if (summary.totalPending > 0) {
        document.title = `(${summary.totalPending}) Approval Dashboard`;
      } else {
        document.title = 'Approval Dashboard';
      }
    }

    // Determine project mode (with offline detection)
    function getEffectiveMode(project) {
      const fiveMinutes = 5 * 60 * 1000;
      if (Date.now() - project.updatedAt > fiveMinutes) {
        return 'offline';
      }
      return project.mode;
    }

    // Get button class based on option text
    function getButtonClass(option) {
      const lower = option.toLowerCase();
      if (lower.includes('don\'t ask') || lower.includes('always') || lower.includes('remember')) {
        return 'remember';
      }
      if (lower === 'no' || lower.includes('deny') || lower.includes('reject') || lower.includes('cancel')) {
        return 'no';
      }
      return 'yes';
    }

    // Render projects
    function renderProjects() {
      if (projects.length === 0) {
        projectsContainer.innerHTML = `
          <div class="empty-state">
            <h2>No Projects</h2>
            <p>Waiting for VS Code extensions to connect...</p>
          </div>
        `;
        return;
      }

      // Sort projects: waiting_approval first, then by pendingCount, then by lastActivityAt
      const sorted = [...projects].sort((a, b) => {
        const modeA = getEffectiveMode(a);
        const modeB = getEffectiveMode(b);

        // waiting_approval always first
        if (modeA === 'waiting_approval' && modeB !== 'waiting_approval') return -1;
        if (modeB === 'waiting_approval' && modeA !== 'waiting_approval') return 1;

        // Then by pending count
        if (a.pendingCount !== b.pendingCount) return b.pendingCount - a.pendingCount;

        // Then by last activity
        return b.lastActivityAt - a.lastActivityAt;
      });

      projectsContainer.innerHTML = sorted.map(project => {
        const mode = getEffectiveMode(project);
        const statusText = mode === 'offline' ? 'Offline' :
                          mode === 'waiting_approval' ? 'Waiting Approval' :
                          mode === 'running' ? 'Running' : 'Idle';

        const approvalsHTML = project.pendingApprovals.length > 0
          ? project.pendingApprovals.map(approval => {
              const isLoading = loadingRequests.has(approval.requestId);
              return `
                <div class="approval-item" data-request-id="${approval.requestId}">
                  <div class="approval-message">${escapeHtml(approval.message)}</div>
                  <div class="approval-meta">
                    <span class="severity-badge ${approval.severity}">${approval.severity}</span>
                    <span class="time-ago">Waiting: ${formatDuration(Date.now() - approval.since)}</span>
                  </div>
                  <div class="approval-actions">
                    ${approval.options.map(option => `
                      <button
                        class="approval-btn ${getButtonClass(option)} ${isLoading ? 'loading' : ''}"
                        onclick="respond('${project.projectId}', '${approval.requestId}', '${escapeHtml(option)}')"
                        ${isLoading ? 'disabled' : ''}
                      >${escapeHtml(option)}</button>
                    `).join('')}
                  </div>
                </div>
              `;
            }).join('')
          : '<div class="no-approvals">No pending approvals</div>';

        return `
          <div class="project-card ${mode}">
            <div class="project-header">
              <div class="project-title">
                <div class="project-indicator ${mode}"></div>
                <span class="project-name">${escapeHtml(project.projectLabel || project.projectId)}</span>
                <span class="project-status">${statusText}</span>
              </div>
              ${project.pendingCount > 0 ? `<span class="pending-badge">${project.pendingCount} pending</span>` : ''}
            </div>
            <div class="project-meta">
              Last activity: ${formatTimeAgo(project.lastActivityAt)}
              ${project.lastTextEditAt ? ` | Last edit: ${formatTimeAgo(project.lastTextEditAt)}` : ''}
            </div>
            <div class="project-body">
              ${approvalsHTML}
            </div>
          </div>
        `;
      }).join('');
    }

    // Escape HTML
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Send approval response
    async function respond(projectId, requestId, response) {
      loadingRequests.add(requestId);
      renderProjects();

      try {
        const res = await fetch('/api/respond', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projectId, requestId, response })
        });

        const data = await res.json();

        if (!res.ok) {
          showError(data.error || 'Failed to send response');
        }
      } catch (error) {
        showError(`Network error: ${error.message}`);
      } finally {
        loadingRequests.delete(requestId);
        renderProjects();
      }
    }

    // Show error message
    function showError(message) {
      errorBanner.textContent = message;
      errorBanner.classList.add('visible');
      setTimeout(() => {
        errorBanner.classList.remove('visible');
      }, 5000);
    }

    // Update connection status
    function setConnected(connected) {
      if (connected) {
        connectionDot.classList.add('connected');
        connectionDot.classList.remove('disconnected');
        connectionText.textContent = 'Connected';
      } else {
        connectionDot.classList.remove('connected');
        connectionDot.classList.add('disconnected');
        connectionText.textContent = 'Disconnected';
      }
    }

    // Connect to SSE
    function connect() {
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource('/api/events');

      eventSource.onopen = () => {
        setConnected(true);
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
          reconnectTimer = null;
        }
      };

      eventSource.onerror = () => {
        setConnected(false);
        eventSource.close();
        eventSource = null;

        // Reconnect after 2 seconds
        if (!reconnectTimer) {
          reconnectTimer = setTimeout(connect, 2000);
        }
      };

      eventSource.addEventListener('init', (event) => {
        const data = JSON.parse(event.data);
        projects = data.projects;
        summary = data.summary;
        updateSummary();
        renderProjects();
      });

      eventSource.addEventListener('state-change', (event) => {
        const data = JSON.parse(event.data);
        const index = projects.findIndex(p => p.projectId === data.projectId);
        if (index >= 0) {
          projects[index] = data;
        } else {
          projects.push(data);
        }

        // Recalculate summary
        summary = {
          totalPending: projects.reduce((sum, p) => sum + p.pendingCount, 0),
          runningCount: projects.filter(p => p.mode === 'running').length,
          idleCount: projects.filter(p => p.mode === 'idle').length
        };

        updateSummary();
        renderProjects();
      });

      eventSource.addEventListener('project-removed', (event) => {
        const data = JSON.parse(event.data);
        projects = projects.filter(p => p.projectId !== data.projectId);

        // Recalculate summary
        summary = {
          totalPending: projects.reduce((sum, p) => sum + p.pendingCount, 0),
          runningCount: projects.filter(p => p.mode === 'running').length,
          idleCount: projects.filter(p => p.mode === 'idle').length
        };

        updateSummary();
        renderProjects();
      });

      eventSource.addEventListener('new-approval', (event) => {
        // Play notification sound if available
        if (Notification.permission === 'granted') {
          new Notification('New Approval Request', {
            body: 'A project needs your approval',
            icon: '/favicon.ico'
          });
        }
      });
    }

    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }

    // Update time displays every second
    setInterval(() => {
      const timeAgoElements = document.querySelectorAll('.time-ago');
      timeAgoElements.forEach(el => {
        // Force re-render to update times
      });
      renderProjects();
    }, 1000);

    // Initial connection
    connect();
  </script>
</body>
</html>
