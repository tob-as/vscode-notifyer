name: Deploy Microtool

on:
  push:
    branches:
      - main
      - staging
      - develop
  pull_request:
    types: [opened, synchronize]

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  # Security check for internal apps
  security-check:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - uses: actions/checkout@v4

      - name: Check app visibility
        id: check
        run: |
          VISIBILITY=$(yq '.visibility' .github/app-config.yml 2>/dev/null || echo "internal")
          echo "App visibility: $VISIBILITY"

          if [ "$VISIBILITY" = "public" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For internal apps, check if Access protection exists
          BRANCH="${GITHUB_REF_NAME}"
          WORKER_NAME="${{ github.event.repository.name }}"

          case "$BRANCH" in
            main) WORKER_SUFFIX="-prod" ;;
            staging) WORKER_SUFFIX="-staging" ;;
            develop) WORKER_SUFFIX="-dev" ;;
            *) WORKER_SUFFIX="-preview" ;;
          esac

          FULL_WORKER_NAME="${WORKER_NAME}-api${WORKER_SUFFIX}"
          echo "Checking Access protection for: $FULL_WORKER_NAME"

          ACCESS_CHECK=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/access/apps" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" | jq -r ".result[] | select(.name == \"$FULL_WORKER_NAME\") | .id")

          if [ -z "$ACCESS_CHECK" ]; then
            echo "::error::Internal app '$FULL_WORKER_NAME' has no Cloudflare Access protection!"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "Access protection verified"
          echo "should_deploy=true" >> $GITHUB_OUTPUT

  # Build job
  build:
    runs-on: ubuntu-latest
    needs: security-check
    if: needs.security-check.outputs.should_deploy == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Upload web build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: apps/web/dist/

  # Deploy API
  deploy-api:
    runs-on: ubuntu-latest
    needs: [security-check, build]
    if: needs.security-check.outputs.should_deploy == 'true' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Determine environment
        id: env
        run: |
          case "${{ github.ref_name }}" in
            main) echo "env=" >> $GITHUB_OUTPUT ;;
            staging) echo "env=--env staging" >> $GITHUB_OUTPUT ;;
            develop) echo "env=--env dev" >> $GITHUB_OUTPUT ;;
          esac

      - name: Deploy API
        working-directory: apps/api
        run: npx wrangler deploy ${{ steps.env.outputs.env }}

  # Deploy Web
  deploy-web:
    runs-on: ubuntu-latest
    needs: [security-check, build]
    if: needs.security-check.outputs.should_deploy == 'true' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: apps/web/dist/

      - name: Determine environment
        id: env
        run: |
          case "${{ github.ref_name }}" in
            main) echo "branch=" >> $GITHUB_OUTPUT ;;
            staging) echo "branch=--branch=staging" >> $GITHUB_OUTPUT ;;
            develop) echo "branch=--branch=dev" >> $GITHUB_OUTPUT ;;
          esac

      - name: Deploy Web
        working-directory: apps/web
        run: npx wrangler pages deploy dist --project-name=${{ github.event.repository.name }}-web ${{ steps.env.outputs.branch }}

  # Preview deploy for PRs
  preview:
    runs-on: ubuntu-latest
    needs: [security-check, build]
    if: needs.security-check.outputs.should_deploy == 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: apps/web/dist/

      - name: Deploy Preview
        id: preview
        run: |
          cd apps/api && npx wrangler deploy --env dev
          cd ../web && npx wrangler pages deploy dist --project-name=${{ github.event.repository.name }}-web --branch=pr-${{ github.event.number }}
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ Preview deployed!'
            })
