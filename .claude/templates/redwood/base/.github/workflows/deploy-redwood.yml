name: Deploy RedwoodSDK

on:
  push:
    branches:
      - main
      - staging
      - develop
  pull_request:
    types: [opened, synchronize]

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  # Security check for internal apps
  security-check:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - uses: actions/checkout@v4

      - name: Check app visibility
        id: check
        run: |
          VISIBILITY=$(yq '.visibility' .github/app-config.yml 2>/dev/null || echo "internal")
          echo "App visibility: $VISIBILITY"

          if [ "$VISIBILITY" = "public" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For internal apps, check if this is a Worker repo
          if [ ! -f "wrangler.jsonc" ] && [ ! -f "wrangler.toml" ]; then
            echo "Not a Worker repo, skipping Access check"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Determine worker name based on branch
          BRANCH="${GITHUB_REF_NAME}"
          WORKER_NAME="${{ github.event.repository.name }}"

          case "$BRANCH" in
            main) WORKER_SUFFIX="-prod" ;;
            staging) WORKER_SUFFIX="-staging" ;;
            develop) WORKER_SUFFIX="-dev" ;;
            *) WORKER_SUFFIX="-preview" ;;
          esac

          FULL_WORKER_NAME="${WORKER_NAME}${WORKER_SUFFIX}"
          echo "Checking Access protection for: $FULL_WORKER_NAME"

          # Check if Access application exists
          ACCESS_CHECK=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/access/apps" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_ACCESS_TOKEN }}" \
            -H "Content-Type: application/json" | jq -r ".result[] | select(.name == \"$FULL_WORKER_NAME\") | .id")

          if [ -z "$ACCESS_CHECK" ]; then
            echo "::error::Internal app '$FULL_WORKER_NAME' has no Cloudflare Access protection!"
            echo "Deploy blocked. Create Access application first via Terraform."
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "Access protection verified for $FULL_WORKER_NAME"
          echo "should_deploy=true" >> $GITHUB_OUTPUT

  # Build job
  build:
    runs-on: ubuntu-latest
    needs: security-check
    if: needs.security-check.outputs.should_deploy == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type Check
        run: npm run typecheck

      - name: Run Tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: dist/

  # Deploy job
  deploy:
    runs-on: ubuntu-latest
    needs: [security-check, build]
    if: needs.security-check.outputs.should_deploy == 'true' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: dist/

      - name: Determine environment
        id: env
        run: |
          case "${{ github.ref_name }}" in
            main)
              echo "env=" >> $GITHUB_OUTPUT
              echo "env_name=prod" >> $GITHUB_OUTPUT
              echo "badge_color=#22c55e" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "env=--env staging" >> $GITHUB_OUTPUT
              echo "env_name=staging" >> $GITHUB_OUTPUT
              echo "badge_color=#f59e0b" >> $GITHUB_OUTPUT
              ;;
            develop)
              echo "env=--env dev" >> $GITHUB_OUTPUT
              echo "env_name=dev" >> $GITHUB_OUTPUT
              echo "badge_color=#ef4444" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Deploy to Cloudflare
        run: |
          npx wrangler deploy ${{ steps.env.outputs.env }}

  # Preview deploy for PRs
  preview:
    runs-on: ubuntu-latest
    needs: [security-check, build]
    if: needs.security-check.outputs.should_deploy == 'true' && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: dist/

      - name: Deploy Preview
        id: preview
        run: |
          OUTPUT=$(npx wrangler deploy --env dev 2>&1)
          echo "$OUTPUT"
          URL=$(echo "$OUTPUT" | grep -oP 'https://[^\s]+\.workers\.dev' | head -1)
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ Preview deployed: ${{ steps.preview.outputs.url }}'
            })
