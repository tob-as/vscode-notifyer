# Progressive Web App (PWA) Setup

## Overview

Every app should be installable as a PWA, providing:
- Offline support
- Home screen installation
- Native app-like experience
- Push notifications (optional)

## Templates

Copy from `.claude/templates/shared/pwa/`:

| Template | Purpose |
|----------|---------|
| `index.template.html` | HTML with viewport, theme-color, manifest link |
| `manifest.template.json` | PWA manifest |
| `vite-pwa.config.template.ts` | Vite plugin configuration |
| `register-sw.template.ts` | Manual SW registration (if not using plugin) |
| `lighthouse-budget.json` | Lighthouse CI performance budgets |

---

## Setup

### 1. Install vite-plugin-pwa

```bash
npm install --save-dev vite-plugin-pwa
```

### 2. Configure Vite

Copy `vite-pwa.config.template.ts` from templates and integrate into `vite.config.ts`:

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { VitePWA } from 'vite-plugin-pwa';

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      manifest: {
        name: 'My App',
        short_name: 'App',
        // ... rest of manifest
      },
    }),
  ],
});
```

### 3. Add Icons

Create icons in `public/icons/`:
- `icon-192.png` (192x192px)
- `icon-512.png` (512x512px)

Use a tool like [Favicon Generator](https://realfavicongenerator.net/) or create with:

```bash
# Using ImageMagick
convert logo.svg -resize 192x192 public/icons/icon-192.png
convert logo.svg -resize 512x512 public/icons/icon-512.png
```

### 4. Add Meta Tags

In your HTML head (usually in `index.html` or Document component):

```html
<meta name="theme-color" content="#3b82f6" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="/manifest.webmanifest" />
<link rel="apple-touch-icon" href="/icons/icon-192.png" />
```

---

## Offline Support

The service worker (generated by vite-plugin-pwa) caches:
- All static assets (JS, CSS, HTML, images)
- API responses (with NetworkFirst strategy)

### Custom Offline Page

For routes that can't be cached, show an offline page:

```typescript
// In your router or error boundary
if (!navigator.onLine) {
  return <OfflinePage />;
}
```

---

## Testing PWA

### Lighthouse

Run Lighthouse PWA audit:

```bash
npx lighthouse https://your-app.com --only-categories=pwa
```

Target: 100% PWA score

### Lighthouse CI

For automated testing in CI, copy `.claude/templates/shared/ci/lighthouse.yml` to `.github/workflows/`.

This runs after each deployment and:
- Checks PWA score (warn if < 90%)
- Checks performance score (warn if < 80%)
- Uploads detailed reports
- Comments on PRs with results

### Manual Testing

1. Open DevTools → Application → Manifest
2. Check "Installable" status
3. Test "Add to Home Screen"
4. Toggle offline in Network tab
5. Verify offline behavior

### Automated Testing (Playwright)

```typescript
test('app is installable', async ({ page }) => {
  await page.goto('/');

  // Check for install prompt or manifest
  const manifest = await page.evaluate(() =>
    fetch('/manifest.webmanifest').then(r => r.json())
  );

  expect(manifest.name).toBeDefined();
  expect(manifest.icons.length).toBeGreaterThan(0);
});
```

---

## PWA Checklist

- [ ] Valid manifest.webmanifest
- [ ] Icons (192x192, 512x512)
- [ ] Service worker registered
- [ ] Works offline (shows cached content or offline page)
- [ ] HTTPS enabled (required for PWA)
- [ ] Viewport meta tag
- [ ] Theme color meta tag
- [ ] Lighthouse PWA score ≥ 90%

---

## Common Issues

### "Site cannot be installed"

- Check manifest is valid JSON
- Ensure icons exist and are correct size
- Verify HTTPS (or localhost)
- Check `start_url` is accessible

### Service Worker Not Updating

```typescript
// Force update in vite-plugin-pwa config
registerType: 'autoUpdate',
```

Or manually:
```javascript
navigator.serviceWorker.getRegistrations().then(registrations => {
  registrations.forEach(r => r.update());
});
```

### Caching Issues in Development

```typescript
// In vite-plugin-pwa config
devOptions: {
  enabled: true,
  type: 'module',
},
```
